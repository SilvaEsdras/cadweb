{% extends "base.html" %}

{% block titulo_conteudo %} Detalhes do Pedido #{{ pedido.id }} {% endblock titulo_conteudo %}

{% block conteudo %} 

<div class="card mb-3">
    <div class="card-body">
        <p><strong>Cliente:</strong> {{ pedido.cliente.nome }}</p>
        <p><strong>Data do Pedido:</strong> {{ pedido.data_pedidof }}</p>
        <p><strong>Status:</strong> {{ pedido.get_status_display }}</p>
        
        <h4 class="mt-3">Total do Pedido: R$ {{ pedido.total }}</h4>
    </div>
</div>

<hr>

<h5>{% if editando %}Editar Produto{% else %}Adicionar Produto{% endif %}</h5>

<form method="POST" class="mb-4">
    {% csrf_token %}
    
    <div class="mb-3">
        <label for="id_produto_nome" class="form-label">Produto:</label>    
        {% if editando %}
            <input type="text" class="form-control" value="{{ form.instance.produto.nome }}" disabled>
            <input type="hidden" name="produto" value="{{ form.instance.produto.id }}">
        {% else %}
            <input type="text" class="form-control autocomplete" 
                    id="id_produto_nome" 
                    data-url="{% url 'buscar_dados' 'home.Produto' %}" 
                    data-hidden="#id_produto" 
                    placeholder="Digite o nome do produto...">
            {{ form.produto }} 
        {% endif %}
    </div>

    <div class="mb-3">
        <label for="id_qtde" class="form-label">Quantidade:</label>
        {{ form.qtde }}
    </div>
    
    {{ form.pedido }}
    
    <div class="mt-3">
        <button type="submit" class="btn btn-primary btn-sm">Salvar Produto</button>
        
        <a href="{% url 'form_pagamento' pedido.id %}" class="btn btn-success btn-sm">Registrar Pagamento</a>
        
        <a href="{% url 'nota_fiscal' pedido.id %}" target="_blank" class="btn btn-info btn-sm">Nota Fiscal</a>
        
        <a href="{% url 'pedido' %}" class="btn btn-secondary btn-sm">Voltar</a>
    </div>
</form>

<hr>

<h5>Itens do Pedido</h5>
<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Preço Unitário (R$)</th>
            <th>Total (R$)</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody>
        {% for item in pedido.itempedido_set.all %}
        <tr {% if item_pedido and item.id == item_pedido.id %}class="table-warning"{% endif %}>
            <td>{{ item.produto.nome }}</td>
            <td>{{ item.qtde }}</td>
            <td>{{ item.preco }}</td>
            
            <td>{{ item.total }}</td> 
            
            <td>
              <a href="{% url 'editar_item_pedido' item.id %}" class="btn btn-warning btn-sm">Editar</a>
              <a href="{% url 'remover_item_pedido' item.id %}" class="btn btn-danger btn-sm" 
              onclick="return confirm('Tem certeza que deseja remover este item? O estoque será devolvido.');">Remover</a>
            </td>         
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" class="text-center">Nenhum item adicionado a este pedido.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock conteudo %}